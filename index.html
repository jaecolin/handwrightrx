<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>林佑彥醫師 - 水煎藥處方生成器 (極簡單行版 v20)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 引入 Google Fonts：明體 (Noto Serif TC)、黑體 (Noto Sans TC) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        /* 字體類別設定 */
        .font-ming {
            font-family: 'Noto Serif TC', 'PMingLiU', 'MingLiU', serif !important;
        }
        
        .font-hei {
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', 'PingFang TC', sans-serif !important;
        }
        
        /* 嚴格的 A4 列印設定：支援多頁不溢出 */
        @page {
            size: A4 portrait;
            margin: 0; 
        }
        
        @media print {
            .no-print { display: none !important; }
            body { 
                background: white; 
                margin: 0; 
                padding: 0; 
                -webkit-print-color-adjust: exact;
            }
            .print-page { 
                box-shadow: none !important; 
                margin: 0 !important; 
                width: 210mm !important; 
                height: 297mm !important; 
                padding: 12mm 15mm !important; /* 縮減列印邊界，爭取更多內容空間 */
                box-sizing: border-box !important;
                page-break-after: always !important; /* 強制分頁 */
                page-break-inside: avoid !important;
                overflow: hidden !important; 
            }
            .print-page:last-child {
                page-break-after: auto !important; /* 最後一頁不加空白頁 */
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-ming">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const CLINIC_INFO = {
            nameZh: "祥峻中醫診所",
            address: "台中市西屯區市政北一路1號6樓之1",
            phone: "04-2473-5561",
            physician: "林佑彥 醫師",
            license: "台中字第010625號"
        };

        const IconWrapper = ({ children, className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>;
        const Printer = ({ className }) => <IconWrapper className={className}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></IconWrapper>;
        const Syringe = ({ className }) => <IconWrapper className={className}><path d="m18 2 4 4"/><path d="m17 7 3-3"/><path d="M19 9 8.7 19.3c-1 1-2.5 1-3.4 0l-.6-.6c-1-1-1-2.5 0-3.4L15 5"/><path d="m9 11 4 4"/><path d="m5 19-3 3"/><path d="m14 4 6 6"/></IconWrapper>;
        const User = ({ className }) => <IconWrapper className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconWrapper>;

        function App() {
            const DEFAULT_TEXT = `醫師：林佑彥  自費  (內)  [123456]
用藥：2 x14/1天2次    
處方：柴胡(自)(?1.5錢  黃芩(自)(?1.5錢  薑半夏(自) 1.0錢
      山梔子(自) 0.5錢  茵陳蒿(自) 0.5錢  夏枯草(自) 1.0錢
      龍膽草(自) 0.5錢  枳實(自)(?0.5錢  烏藥(自)(?1.0錢
      遠志(自)(?1.0錢  石菖蒲(自) 0.5錢  蓮子心(自) 0.5錢
      乾薑(自)(?1.0錢  黨參(自)(?1.0錢  土炒白朮(?1.0錢
      雲茯苓(自) 1.0錢  葛根(自)(?1.0錢  桑寄生(自) 1.0錢
      旱蓮草(自) 1.0錢  地骨皮(自) 1.0錢  牡丹皮(自) 1.0錢
      細辛(自)(?0.5錢  生甘草(自) 1.0錢  紅大棗(自) 1.0錢
      酒大黃(自) 1.0錢  飲片代煎費 1.0天  飲片代寄運 1.0`;

            const [rawText, setRawText] = useState(DEFAULT_TEXT);
            const [chartNo, setChartNo] = useState("");
            const [patientName, setPatientName] = useState("");
            const [visitDate, setVisitDate] = useState(new Date().toISOString().split('T')[0]);
            const [medicationInfo, setMedicationInfo] = useState("");
            const [parsedData, setParsedData] = useState({ medicines: [], others: [] });
            
            // 自動偵測是否需要代煎/寄送
            const needsDelivery = /代煎|寄運|代寄/i.test(rawText);

            const parsePrescription = (text) => {
                const medicines = [];
                const others = [];

                // 擷取病歷號 (從 [ ] 中擷取)
                const chartMatch = text.match(/\[\s*([a-zA-Z0-9]+)\s*-?\]/);
                if (chartMatch && !chartNo) {
                    setChartNo(chartMatch[1].trim());
                }

                const medMatch = text.match(/用藥：.*?([Xx])\s*(\d+)\s*\/\s*1天\s*(\d+)\s*次/i);
                if (medMatch) {
                    const days = medMatch[2];
                    const times = medMatch[3];
                    let timeStr = `每日${times}次`;
                    if (times === "2") timeStr = "早晚服用";
                    if (times === "3") timeStr = "三餐服用";
                    setMedicationInfo(`${days}天份，${timeStr}`);
                } else {
                    setMedicationInfo("");
                }

                let cleanText = text.replace(/醫師：.*?\n/, '') 
                                    .replace(/用藥：.*?\n/, '') 
                                    .replace(/處方：/, '');    

                const regex = /([\u4e00-\u9fa5]+)(?:[\(\)自\?\[\]\s]*?)(\d+(?:\.\d+)?)(?:[錢天次g克])?/g;
                const matches = [...cleanText.matchAll(regex)];

                const excludeItems = ["代煎", "寄運", "處方籤", "處方簽", "調劑", "掛號"];

                matches.forEach(match => {
                    const name = match[1];
                    const dose = match[2];
                    
                    if (["錢", "天", "次", "克", "公克", "日", "帖"].includes(name)) return;
                    if (excludeItems.some(ex => name.includes(ex))) return;

                    let unit = "錢"; 
                    if (name.includes("天")) unit = "天";
                    else if (name.includes("次")) unit = "次";

                    medicines.push({ name_zh: name, dosage: dose, unit: "錢" });
                });

                setParsedData({ medicines, others });
            };

            useEffect(() => {
                parsePrescription(rawText);
            }, [rawText]);

            // --- 分頁邏輯 (Chunking Logic) ---
            const CHUNK_SIZE = 33; // 更新為每頁最多33味藥 (11行x3)
            const totalMedicines = parsedData.medicines.length;
            const medicineChunks = [];
            
            if (totalMedicines === 0) {
                medicineChunks.push([]);
            } else {
                for (let i = 0; i < totalMedicines; i += CHUNK_SIZE) {
                    medicineChunks.push(parsedData.medicines.slice(i, i + CHUNK_SIZE));
                }
            }
            const totalPages = medicineChunks.length;

            return (
                <div className="min-h-screen pb-10 flex flex-col md:flex-row font-hei text-sm md:text-base">
                    
                    {/* 左側：輸入區 */}
                    <div className="w-full md:w-1/3 p-6 bg-slate-800 text-white overflow-y-auto h-screen sticky top-0 no-print z-10 shrink-0">
                        <h1 className="text-2xl font-bold mb-6 flex items-center text-teal-400">
                            <Syringe className="mr-2" /> 個人處方生成器
                        </h1>

                        <div className="space-y-6">
                            <div className="bg-slate-700 p-4 rounded-lg border border-slate-600">
                                <h2 className="font-bold mb-3 flex items-center text-teal-300"><User className="w-4 h-4 mr-2"/> 1. 患者資訊</h2>
                                <div className="space-y-3">
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-xs text-slate-400 mb-1">病歷號</label>
                                            <input 
                                                type="text" 
                                                value={chartNo}
                                                onChange={(e) => setChartNo(e.target.value)}
                                                placeholder="請輸入病歷號..."
                                                className="w-full bg-slate-900 border border-slate-500 rounded p-2 text-white focus:border-teal-500 outline-none"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-slate-400 mb-1">患者姓名</label>
                                            <input 
                                                type="text" 
                                                value={patientName}
                                                onChange={(e) => setPatientName(e.target.value)}
                                                placeholder="請輸入姓名..."
                                                className="w-full bg-slate-900 border border-slate-500 rounded p-2 text-white focus:border-teal-500 outline-none"
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs text-slate-400 mb-1">開立日期</label>
                                        <input 
                                            type="date" 
                                            value={visitDate}
                                            onChange={(e) => setVisitDate(e.target.value)}
                                            className="w-full bg-slate-900 border border-slate-500 rounded p-2 text-white focus:border-teal-500 outline-none"
                                        />
                                    </div>
                                </div>
                            </div>

                            <div className="bg-slate-700 p-4 rounded-lg border border-slate-600">
                                <h2 className="font-bold mb-3 flex items-center text-teal-300">2. 貼上病歷摘要</h2>
                                <textarea 
                                    value={rawText}
                                    onChange={(e) => setRawText(e.target.value)}
                                    className="w-full h-48 bg-slate-900 border border-slate-500 rounded p-2 text-xs font-mono text-gray-300 focus:border-teal-500 outline-none leading-relaxed"
                                    spellCheck="false"
                                    placeholder="請貼上包含處方的文字..."
                                ></textarea>
                                <div className="mt-2 flex justify-between items-center text-xs text-slate-400 border-t border-slate-600 pt-2">
                                    <span>藥材：{totalMedicines} 味 {totalPages > 1 && `(將列印 ${totalPages} 頁)`}</span>
                                    {medicationInfo && <span className="text-teal-300">{medicationInfo}</span>}
                                </div>
                            </div>

                            <button 
                                onClick={() => window.print()} 
                                className="w-full py-3 bg-teal-600 hover:bg-teal-500 text-white font-bold rounded-lg shadow-lg flex items-center justify-center transition-all"
                            >
                                <Printer className="mr-2" /> 列印 / 另存 PDF
                            </button>
                        </div>
                    </div>

                    {/* 右側：預覽區 (多頁映射渲染) */}
                    <div className="w-full md:w-2/3 bg-gray-200 p-2 md:p-8 flex flex-col items-center overflow-y-auto space-y-8">
                        {medicineChunks.map((chunk, pageIndex) => (
                            <div key={pageIndex} className="print-page bg-white shadow-xl w-[210mm] h-[297mm] p-8 md:p-10 relative flex flex-col text-black box-border overflow-hidden shrink-0">
                                
                                {/* --- 頂部標題區 --- */}
                                <div className="text-center mb-6 pt-2 border-b-2 border-black pb-3 flex-shrink-0">
                                    <div className="flex justify-center items-baseline flex-wrap gap-x-4 gap-y-1">
                                        <h1 className="text-2xl md:text-[26px] font-ming font-bold tracking-[0.1em] text-black">
                                            {CLINIC_INFO.physician} 中醫水煎藥處方箋
                                        </h1>
                                        <p className="text-base font-ming text-black tracking-wider">
                                            TCM Herbal Prescription
                                        </p>
                                    </div>
                                </div>

                                {/* --- I. Patient Info (單行呈現) --- */}
                                <div className="mb-4 font-ming flex-shrink-0">
                                    <h3 className="font-bold text-sm text-black mb-2 border-b border-black pb-1">一、患者資訊</h3>
                                    
                                    <div className="flex justify-between items-center py-1.5 border-b border-gray-300 text-base">
                                        <div className="flex-1">
                                            <span className="font-semibold text-black">病歷號：</span>
                                            <span className="font-bold text-black">{chartNo}</span>
                                        </div>
                                        <div className="flex-1 text-center">
                                            <span className="font-semibold text-black">姓名：</span>
                                            <span className="font-bold text-black">{patientName}</span>
                                        </div>
                                        <div className="flex-1 text-right">
                                            <span className="font-semibold text-black">開立日期：</span>
                                            <span className="font-mono text-black">{visitDate}</span>
                                        </div>
                                    </div>
                                </div>

                                {/* --- II. Prescription --- */}
                                <div className="flex-1 font-ming flex flex-col overflow-hidden">
                                    <div className="flex justify-between items-baseline border-b border-black pb-1 mb-2 flex-shrink-0">
                                        <h3 className="font-bold text-sm text-black">
                                            二、處方明細 {totalPages > 1 && <span className="font-normal text-xs ml-2">(第 {pageIndex + 1}/{totalPages} 頁)</span>}
                                        </h3>
                                        <h4 className="font-bold text-sm text-black">【內服水煎藥】</h4>
                                    </div>

                                    {/* 3欄並列 Grid：增加行間距 gap-y-3 與垂直分隔線，字體放大維持舒適行高 */}
                                    <div className="grid grid-cols-3 gap-y-3 content-start pt-2 flex-1 overflow-hidden">
                                        {chunk.map((item, i) => (
                                            <div key={i} className={`flex justify-between items-baseline border-b border-dashed border-gray-400 py-1.5 ${
                                                i % 3 === 0 ? 'pr-4 border-r border-dotted border-gray-400' : 
                                                i % 3 === 1 ? 'px-4 border-r border-dotted border-gray-400' : 
                                                'pl-4'
                                            }`}>
                                                <span className="text-lg font-bold text-black tracking-wider leading-tight">
                                                    {item.name_zh}
                                                </span>
                                                <span className="text-base font-mono font-bold text-black leading-tight">
                                                    {item.dosage} <span className="text-sm font-normal text-black">錢</span>
                                                </span>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* --- 天數、總計與代煎手寫欄位 --- */}
                                <div className="mt-auto pt-3 border-t border-black flex flex-col gap-2 flex-shrink-0 font-ming">
                                    <div className="flex justify-between items-center">
                                        <div className="text-base font-bold text-black tracking-wide">
                                            {medicationInfo && <span>{medicationInfo}</span>}
                                        </div>
                                        <div>
                                            {pageIndex < totalPages - 1 ? (
                                                <span className="text-sm font-bold text-black italic">（接續下一頁...）</span>
                                            ) : (
                                                <>
                                                    <span className="text-sm text-black mr-2">總計藥材：</span>
                                                    <span className="font-bold text-lg text-black">{totalMedicines} <span className="text-sm font-normal text-black">味</span></span>
                                                </>
                                            )}
                                        </div>
                                    </div>
                                    
                                    {/* 觸發條件：當病歷摘要有代煎、寄送字眼時，並且是在最後一頁才顯示行政手寫欄位 */}
                                    {needsDelivery && pageIndex === totalPages - 1 && (
                                        <div className="flex justify-between items-center pt-2 mt-1 border-t border-dashed border-gray-400">
                                            <span className="text-xs text-black italic">※ 此處方含代煎 / 代寄運服務</span>
                                            <div>
                                                <span className="text-sm font-bold text-black mr-2">預計出貨 / 寄送日期：</span>
                                                <span className="inline-block w-36 border-b border-black align-text-bottom"></span>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* --- III. Footer 醫囑與診所資訊 --- */}
                                <div className="pt-4 border-t-2 border-black font-hei flex-shrink-0">
                                    <div className="flex justify-between items-end mb-4">
                                        <div className="text-left flex-1 pr-2">
                                            <p className="text-xs font-bold text-black mb-1">醫師叮嚀：</p>
                                            <p className="text-xs text-black leading-relaxed">
                                                1. 藥物僅輔助疏通，療效關鍵仍在您的生活作息與情緒。<br/>
                                                2. 放下對數據的執著，治療終點在找回生活品質與平靜。<br/>
                                                3. 服藥期間若有任何不適，請先停藥，並於回診時討論。<br/>
                                                4. 本處方適用當次門診之體質與病情，每次皆需經醫師重新評估開立。
                                            </p>
                                        </div>
                                        {/* 調整署名與蓋章區塊：使用 flex-row 讓名字在前，蓋章在後 */}
                                        <div className="flex items-center gap-4 shrink-0">
                                            <div className="text-right">
                                                <p className="font-bold text-xl border-b border-black pb-1 min-w-[120px] font-ming text-black text-center">
                                                    {CLINIC_INFO.physician}
                                                </p>
                                                <p className="text-[10px] text-black mt-1 text-center">執照號：{CLINIC_INFO.license}</p>
                                            </div>
                                            {/* 蓋章區 */}
                                            <div className="w-16 h-16 border border-black rounded-full opacity-20 flex items-center justify-center shrink-0">
                                                <span className="text-black text-[10px] transform -rotate-12">醫師章</span>
                                            </div>
                                        </div>
                                    </div>

                                    {/* 最下方的診所資訊 */}
                                    <div className="border-t border-gray-400 pt-2 flex flex-wrap justify-between items-center text-[10px] text-black">
                                        <div className="flex gap-4">
                                            <span className="font-bold text-black">{CLINIC_INFO.nameZh}</span>
                                            <span>電話: {CLINIC_INFO.phone}</span>
                                        </div>
                                        <div>
                                            <span>地址: {CLINIC_INFO.address}</span>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
