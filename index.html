<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>林佑彥醫師 - 水煎藥處方生成器 (患者資訊排版優化 v14)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 引入 Google Fonts：明體 (Noto Serif TC)、黑體 (Noto Sans TC) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        /* 字體類別設定 */
        .font-ming {
            font-family: 'Noto Serif TC', 'PMingLiU', 'MingLiU', serif !important;
        }
        
        .font-hei {
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', 'PingFang TC', sans-serif !important;
        }
        
        /* 嚴格的 A4 列印設定：確保單頁不溢出 */
        @page {
            size: A4 portrait;
            margin: 0; 
        }
        
        @media print {
            .no-print { display: none !important; }
            body { 
                background: white; 
                margin: 0; 
                padding: 0; 
                -webkit-print-color-adjust: exact;
            }
            #print-area { 
                box-shadow: none !important; 
                margin: 0 !important; 
                width: 210mm !important; 
                height: 297mm !important; 
                padding: 12mm 15mm !important; /* 縮減列印邊界，爭取更多內容空間 */
                box-sizing: border-box !important;
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
                overflow: hidden !important; /* 強制不溢出 */
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-ming">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const CLINIC_INFO = {
            nameZh: "祥峻中醫診所",
            address: "台中市西屯區市政北一路1號6樓之1",
            phone: "04-2473-5561",
            physician: "林佑彥 醫師",
            license: "台中字第010625號"
        };

        const LOCAL_ICD_DICT = {
            // --- 內科與體質常見 ---
            "E11.9": "第二型糖尿病",
            "E11.319": "第二型糖尿病併視網膜病變",
            "I10": "原發性高血壓",
            "G47.00": "失眠",
            "G47.9": "睡眠障礙",
            "J30.4": "過敏性鼻炎",
            "K21.9": "胃食道逆流",
            "F41.9": "焦慮症",
            "F32.9": "憂鬱症",
            "M54.5": "下背痛",
            "R53.83": "疲倦",

            // --- 眼科常見清單 (擴充後) ---
            "H00.0": "麥粒腫",
            "H00.1": "霰粒腫",
            "H01.0": "眼瞼炎",
            "H02.0": "瞼內翻",
            "H02.1": "瞼外翻",
            "H02.4": "眼瞼下垂",
            "H04.1": "乾眼症",
            "H04.121": "乾眼症 (右眼)",
            "H04.122": "乾眼症 (左眼)",
            "H04.123": "乾眼症 (雙眼)",
            "H04.2": "淚溢",
            "H10.0": "結膜炎",
            "H10.1": "急性異位性結膜炎",
            "H10.9": "結膜炎",
            "H11.0": "翼狀胬肉",
            "H16.0": "角膜潰瘍",
            "H16.1": "結膜角膜炎",
            "H18.0": "角膜色素沉著",
            "H20.0": "急性及亞急性虹膜睫狀體炎",
            "H25.0": "老年性初發性白內障",
            "H25.9": "老年性白內障, 未明示",
            "H26.0": "嬰兒、少年和初老性白內障",
            "H26.9": "白內障, 未明示",
            "H30.0": "局限性脈絡膜視網膜發炎",
            "H33.0": "視網膜剝離伴有視網膜裂孔",
            "H35.0": "背景視網膜病變",
            "H35.3": "黃斑部變性",
            "H35.30": "黃斑部退化",
            "H35.81": "視網膜水腫",
            "H36.0": "糖尿病性視網膜病變",
            "H40.1": "原發性開角型青光眼",
            "H40.11": "原發性開角型青光眼",
            "H40.2": "原發性閉角型青光眼",
            "H40.9": "青光眼",
            "H43.1": "玻璃體出血",
            "H43.3": "玻璃體膜混濁",
            "H43.39": "飛蚊症 (其他玻璃體混濁)",
            "H44.0": "化膿性眼內炎",
            "H52.1": "近視",
            "H52.4": "老花眼"
        };

        const IconWrapper = ({ children, className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>;
        const Printer = ({ className }) => <IconWrapper className={className}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></IconWrapper>;
        const Syringe = ({ className }) => <IconWrapper className={className}><path d="m18 2 4 4"/><path d="m17 7 3-3"/><path d="M19 9 8.7 19.3c-1 1-2.5 1-3.4 0l-.6-.6c-1-1-1-2.5 0-3.4L15 5"/><path d="m9 11 4 4"/><path d="m5 19-3 3"/><path d="m14 4 6 6"/></IconWrapper>;
        const User = ({ className }) => <IconWrapper className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconWrapper>;
        const RefreshIcon = ({ className }) => <IconWrapper className={className}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconWrapper>;

        function App() {
            const DEFAULT_TEXT = `病名：H04.123
醫師：林佑彥  自費  (內)  [      -]
脈象：左寸促關尺滑,右寸促關弦尺滑
用藥：2 x14/1天2次    
處方：柴胡(自)(?1.5錢  黃芩(自)(?1.5錢  薑半夏(自) 1.0錢
      山梔子(自) 0.5錢  茵陳蒿(自) 0.5錢  夏枯草(自) 1.0錢
      龍膽草(自) 0.5錢  枳實(自)(?0.5錢  烏藥(自)(?1.0錢
      遠志(自)(?1.0錢  石菖蒲(自) 0.5錢  蓮子心(自) 0.5錢
      乾薑(自)(?1.0錢  黨參(自)(?1.0錢  土炒白朮(?1.0錢
      雲茯苓(自) 1.0錢  葛根(自)(?1.0錢  桑寄生(自) 1.0錢
      旱蓮草(自) 1.0錢  地骨皮(自) 1.0錢  牡丹皮(自) 1.0錢
      細辛(自)(?0.5錢  生甘草(自) 1.0錢  紅大棗(自) 1.0錢
      酒大黃(自) 1.0錢  飲片代煎費 1.0天  飲片代寄運 1.0`;

            const [rawText, setRawText] = useState(DEFAULT_TEXT);
            const [patientName, setPatientName] = useState("");
            const [visitDate, setVisitDate] = useState(new Date().toISOString().split('T')[0]);
            const [pulse, setPulse] = useState("");
            const [diagnosis, setDiagnosis] = useState("");
            const [medicationInfo, setMedicationInfo] = useState("");
            const [isSyncing, setIsSyncing] = useState(false);
            const [parsedData, setParsedData] = useState({ medicines: [], others: [] });

            const handleSyncICD = async () => {
                const match = diagnosis.match(/[A-Za-z]\d{2}(?:\.[A-Za-z0-9]+)?/);
                if (!match) {
                    alert("請先輸入有效的 ICD-10 代碼 (例如: H04.123 或 E11.9)");
                    return;
                }

                const code = match[0].toUpperCase();
                setIsSyncing(true);

                try {
                    if (LOCAL_ICD_DICT[code]) {
                        setDiagnosis(`${code} ${LOCAL_ICD_DICT[code]}`);
                        setIsSyncing(false);
                        return;
                    }

                    const res = await fetch(`https://clinicaltables.nlm.nih.gov/api/icd10cm/v3/search?terms=${code}`);
                    const data = await res.json();

                    if (data[0] > 0) {
                        const fetchedCode = data[3][0][0];
                        const fetchedNameEn = data[3][0][1];
                        
                        try {
                            const transRes = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(fetchedNameEn)}&langpair=en|zh-TW`);
                            const transData = await transRes.json();
                            const fetchedNameZh = transData.responseData.translatedText;
                            
                            if(fetchedNameZh && !fetchedNameZh.includes("MYMEMORY")) {
                                setDiagnosis(`${fetchedCode} ${fetchedNameZh}`);
                            } else {
                                setDiagnosis(`${fetchedCode} ${fetchedNameEn}`);
                            }
                        } catch (translateError) {
                            setDiagnosis(`${fetchedCode} ${fetchedNameEn}`);
                        }
                    } else {
                        alert(`線上資料庫找不到代碼：${code}`);
                    }
                } catch (error) {
                    console.error("同步失敗:", error);
                    alert("同步失敗，請檢查網路連線。");
                } finally {
                    setIsSyncing(false);
                }
            };

            const parsePrescription = (text) => {
                const medicines = [];
                const others = [];

                const pulseMatch = text.match(/脈[象診]?\s*[:：]\s*([^\s\n]+)/);
                if (pulseMatch) {
                    setPulse(pulseMatch[1].trim());
                }

                const dxMatch = text.match(/(?:病名|診斷|ICD(?:-10)?)[^\w\u4e00-\u9fa5]*([A-Za-z]\d{2}(?:\.[A-Za-z0-9]+)?)([^\n]*)/);
                if (dxMatch) {
                    const code = dxMatch[1].toUpperCase();
                    const restOfLine = dxMatch[2].trim();
                    
                    if (LOCAL_ICD_DICT[code] && !restOfLine.includes(LOCAL_ICD_DICT[code])) {
                        setDiagnosis(`${code} ${LOCAL_ICD_DICT[code]}`);
                    } else {
                        setDiagnosis(`${code} ${restOfLine}`.trim());
                    }
                }

                const medMatch = text.match(/用藥：.*?([Xx])\s*(\d+)\s*\/\s*1天\s*(\d+)\s*次/i);
                if (medMatch) {
                    const days = medMatch[2];
                    const times = medMatch[3];
                    let timeStr = `每日${times}次`;
                    if (times === "2") timeStr = "早晚服用";
                    if (times === "3") timeStr = "三餐服用";
                    setMedicationInfo(`${days}天份，${timeStr}`);
                } else {
                    setMedicationInfo("");
                }

                let cleanText = text.replace(/醫師：.*?\n/, '') 
                                    .replace(/用藥：.*?\n/, '') 
                                    .replace(/處方：/, '');    

                const regex = /([\u4e00-\u9fa5]+)(?:[\(\)自\?\[\]\s]*?)(\d+(?:\.\d+)?)(?:[錢天次g克])?/g;
                const matches = [...cleanText.matchAll(regex)];

                const excludeItems = ["代煎", "寄運", "處方籤", "處方簽", "調劑", "掛號"];

                matches.forEach(match => {
                    const name = match[1];
                    const dose = match[2];
                    
                    if (["錢", "天", "次", "克", "公克", "日", "帖"].includes(name)) return;
                    if (excludeItems.some(ex => name.includes(ex))) return;

                    let unit = "錢"; 
                    if (name.includes("天")) unit = "天";
                    else if (name.includes("次")) unit = "次";

                    medicines.push({ name_zh: name, dosage: dose, unit: "錢" });
                });

                setParsedData({ medicines, others });
            };

            useEffect(() => {
                parsePrescription(rawText);
            }, [rawText]);

            const displayDiagnosis = diagnosis.replace(/^[A-Za-z]\d{2}(?:\.[A-Za-z0-9]+)?\s*/, '');

            return (
                <div className="min-h-screen pb-10 flex flex-col md:flex-row font-hei text-sm md:text-base">
                    
                    {/* 左側：輸入區 (網頁操作介面，保留黑體提升可讀性) */}
                    <div className="w-full md:w-1/3 p-6 bg-slate-800 text-white overflow-y-auto h-screen sticky top-0 no-print z-10">
                        <h1 className="text-2xl font-bold mb-6 flex items-center text-teal-400">
                            <Syringe className="mr-2" /> 個人處方生成器
                        </h1>

                        <div className="space-y-6">
                            <div className="bg-slate-700 p-4 rounded-lg border border-slate-600">
                                <h2 className="font-bold mb-3 flex items-center text-teal-300"><User className="w-4 h-4 mr-2"/> 1. 患者資訊</h2>
                                <div className="space-y-3">
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-xs text-slate-400 mb-1">患者姓名</label>
                                            <input 
                                                type="text" 
                                                value={patientName}
                                                onChange={(e) => setPatientName(e.target.value)}
                                                placeholder="請輸入姓名..."
                                                className="w-full bg-slate-900 border border-slate-500 rounded p-2 text-white focus:border-teal-500 outline-none"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-slate-400 mb-1">開立日期</label>
                                            <input 
                                                type="date" 
                                                value={visitDate}
                                                onChange={(e) => setVisitDate(e.target.value)}
                                                className="w-full bg-slate-900 border border-slate-500 rounded p-2 text-white focus:border-teal-500 outline-none"
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs text-slate-400 mb-1">病名 (輸入代碼後可自動翻譯)</label>
                                        <div className="flex">
                                            <input 
                                                type="text" 
                                                value={diagnosis}
                                                onChange={(e) => setDiagnosis(e.target.value)}
                                                onKeyDown={(e) => { if(e.key === 'Enter') handleSyncICD(); }}
                                                placeholder="輸入代碼如 H04.123"
                                                className="w-full bg-slate-900 border border-slate-500 rounded-l p-2 text-white focus:border-teal-500 outline-none"
                                            />
                                            <button 
                                                onClick={handleSyncICD}
                                                disabled={isSyncing}
                                                className="bg-teal-600 hover:bg-teal-500 text-white px-3 rounded-r border border-teal-600 flex items-center justify-center transition-colors"
                                                title="從線上庫同步並翻譯病名"
                                            >
                                                {isSyncing ? <RefreshIcon className="w-4 h-4 animate-spin" /> : <RefreshIcon className="w-4 h-4" />}
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs text-slate-400 mb-1">脈象</label>
                                        <input 
                                            type="text" 
                                            value={pulse}
                                            onChange={(e) => setPulse(e.target.value)}
                                            placeholder="例如：弦滑"
                                            className="w-full bg-slate-900 border border-slate-500 rounded p-2 text-white focus:border-teal-500 outline-none"
                                        />
                                    </div>
                                </div>
                            </div>

                            <div className="bg-slate-700 p-4 rounded-lg border border-slate-600">
                                <h2 className="font-bold mb-3 flex items-center text-teal-300">2. 貼上病歷摘要</h2>
                                <textarea 
                                    value={rawText}
                                    onChange={(e) => setRawText(e.target.value)}
                                    className="w-full h-48 bg-slate-900 border border-slate-500 rounded p-2 text-xs font-mono text-gray-300 focus:border-teal-500 outline-none leading-relaxed"
                                    spellCheck="false"
                                    placeholder="請貼上包含處方的文字..."
                                ></textarea>
                                <div className="mt-2 flex justify-between items-center text-xs text-slate-400 border-t border-slate-600 pt-2">
                                    <span>藥材：{parsedData.medicines.length} 味</span>
                                    {medicationInfo && <span className="text-teal-300">{medicationInfo}</span>}
                                </div>
                            </div>

                            <button 
                                onClick={() => window.print()} 
                                className="w-full py-3 bg-teal-600 hover:bg-teal-500 text-white font-bold rounded-lg shadow-lg flex items-center justify-center transition-all"
                            >
                                <Printer className="mr-2" /> 列印 / 另存 PDF
                            </button>
                        </div>
                    </div>

                    {/* 右側：預覽區 (嚴格鎖定 A4 尺寸) */}
                    <div className="w-full md:w-2/3 bg-gray-200 p-2 md:p-8 flex justify-center overflow-y-auto">
                        
                        {/* A4 紙張本體：透過 padding 壓縮版面，爭取資料呈現空間 */}
                        <div id="print-area" className="bg-white shadow-xl w-[210mm] h-[297mm] p-8 md:p-10 relative flex flex-col text-black box-border overflow-hidden">
                            
                            {/* --- 頂部標題區 (一行並列、明體 Noto Serif TC) --- */}
                            <div className="text-center mb-6 pt-2 border-b-2 border-gray-800 pb-3 flex-shrink-0">
                                <div className="flex justify-center items-baseline flex-wrap gap-x-4 gap-y-1">
                                    <h1 className="text-2xl md:text-[28px] font-ming font-bold tracking-[0.1em] text-gray-900">
                                        {CLINIC_INFO.physician} 中醫水煎藥處方箋
                                    </h1>
                                    <p className="text-base font-ming text-gray-600 tracking-wider">
                                        TCM Herbal Prescription
                                    </p>
                                </div>
                            </div>

                            {/* --- I. Patient Info (排版調整：三行呈現) --- */}
                            <div className="mb-4 font-ming flex-shrink-0">
                                <h3 className="font-bold text-sm text-gray-800 mb-2 border-b border-gray-300 pb-1">一、患者資訊</h3>
                                <div className="grid grid-cols-2 gap-x-8 gap-y-1 text-sm">
                                    {/* 第一行：姓名與日期 */}
                                    <div className="flex justify-between py-1 border-b border-gray-100">
                                        <span className="font-semibold text-gray-600 shrink-0">姓名：</span>
                                        <span className="font-bold text-base text-right">{patientName}</span>
                                    </div>
                                    <div className="flex justify-between py-1 border-b border-gray-100">
                                        <span className="font-semibold text-gray-600 shrink-0">開立日期：</span>
                                        <span className="font-mono text-base text-right">{visitDate}</span>
                                    </div>
                                    
                                    {/* 第二行：脈象 (全寬) */}
                                    <div className="col-span-2 flex py-1 border-b border-gray-100">
                                        <span className="font-semibold text-gray-600 w-20 shrink-0">脈象：</span>
                                        <span className="font-bold text-base flex-1">{pulse}</span>
                                    </div>
                                    
                                    {/* 第三行：病名 (全寬) */}
                                    <div className="col-span-2 flex py-1 border-b border-gray-100">
                                        <span className="font-semibold text-gray-600 w-20 shrink-0">病名：</span>
                                        <span className="font-bold text-base flex-1">{displayDiagnosis}</span>
                                    </div>
                                </div>
                            </div>

                            {/* --- II. Prescription (明體，內容靠上對齊 content-start) --- */}
                            <div className="flex-1 font-ming flex flex-col overflow-hidden">
                                <h3 className="font-bold text-sm text-gray-800 mb-2 border-b border-gray-300 pb-1 flex-shrink-0">二、處方明細</h3>
                                
                                <div className="flex justify-between items-end mb-2 flex-shrink-0">
                                    <h4 className="font-bold text-sm text-gray-700">【內服水煎藥】</h4>
                                </div>

                                {/* 3欄並列 Grid：增加行高 (gap-y-2)、加強垂直 padding (py-1.5) 給予呼吸空間 */}
                                <div className="grid grid-cols-3 gap-x-6 gap-y-2 content-start border-t-2 border-gray-800 pt-4 flex-1 overflow-hidden">
                                    {parsedData.medicines.map((item, i) => (
                                        <div key={i} className="flex justify-between items-baseline border-b border-dashed border-gray-300 py-1.5 px-1">
                                            <span className="text-base font-bold text-gray-900 tracking-wide leading-relaxed">
                                                {item.name_zh}
                                            </span>
                                            <span className="text-sm font-mono font-bold text-gray-800 leading-relaxed">
                                                {item.dosage} <span className="text-xs font-normal text-gray-600">錢</span>
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* --- 天數與總計 (使用 mt-auto 保證與底部醫囑緊密貼合併沉底) --- */}
                            <div className="mt-auto pt-3 border-t border-gray-300 flex justify-between items-center flex-shrink-0 font-ming">
                                <div className="text-base font-bold text-gray-800 tracking-wide">
                                    {medicationInfo && <span>{medicationInfo}</span>}
                                </div>
                                <div>
                                    <span className="text-xs text-gray-500 mr-2">總計藥材：</span>
                                    <span className="font-bold text-lg">{parsedData.medicines.length} <span className="text-xs font-normal text-gray-600">味</span></span>
                                </div>
                            </div>

                            {/* --- III. Footer 醫囑與診所資訊 (黑體) --- */}
                            <div className="pt-4 border-t-2 border-gray-800 font-hei flex-shrink-0">
                                <div className="flex justify-between items-end mb-4">
                                    <div className="text-left w-2/3 pr-2">
                                        <p className="text-xs font-bold text-gray-700 mb-1">醫師叮嚀：</p>
                                        <p className="text-xs text-gray-600 leading-relaxed">
                                            1. 藥物僅輔助疏通，療效關鍵仍在您的生活作息與情緒。<br/>
                                            2. 放下對數據的執著，治療終點在找回生活品質與平靜。<br/>
                                            3. 服藥期間若有任何不適，請先停藥，並於回診時討論。
                                        </p>
                                    </div>
                                    <div className="w-1/3 text-right">
                                        <div className="inline-block text-center">
                                            <div className="mb-1 relative">
                                                {/* 蓋章區：縮小體積 */}
                                                <div className="w-16 h-16 border border-red-300 rounded-full absolute -top-4 left-1/2 transform -translate-x-1/2 opacity-30 flex items-center justify-center">
                                                    <span className="text-red-300 text-[10px] transform -rotate-12">醫師章</span>
                                                </div>
                                                <p className="font-bold text-lg mb-1 border-b border-black pb-1 min-w-[100px] font-ming">
                                                    {CLINIC_INFO.physician}
                                                </p>
                                            </div>
                                            <p className="text-[10px] text-gray-500 mt-1">執照號：{CLINIC_INFO.license}</p>
                                        </div>
                                    </div>
                                </div>

                                {/* 最下方的診所資訊：字體縮到最小 */}
                                <div className="border-t border-gray-200 pt-2 flex flex-wrap justify-between items-center text-[10px] text-gray-400">
                                    <div className="flex gap-4">
                                        <span className="font-bold text-gray-500">{CLINIC_INFO.nameZh}</span>
                                        <span>電話: {CLINIC_INFO.phone}</span>
                                    </div>
                                    <div>
                                        <span>地址: {CLINIC_INFO.address}</span>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
